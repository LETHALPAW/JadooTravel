@model ResultFeatureDto
@inject JadooTravel.Services.LanguageService.LanguageService LanguageService
@using Microsoft.AspNetCore.Http

@functions {
    private string NormalizeYouTubeUrl(string? url)
    {
        if (string.IsNullOrEmpty(url)) return "";

        var regex = new System.Text.RegularExpressions.Regex(
            @"(?:youtu\.be/|youtube\.com/(?:watch\?v=|embed/|shorts/))([^\?&""'>]+)");
        var match = regex.Match(url);
        if (match.Success)
            return $"https://www.youtube.com/embed/{match.Groups[1].Value}";
        return url;
    }
}

@{
    var lang = Context.Session.GetString("lang") ?? "tr";
    var promoText = await LanguageService.TranslateAsync("Tanıtım Videosu", lang);

    var feature = Model ?? new ResultFeatureDto(); // Model null ise boş nesne

    // Null-safe video URL
    var videoUrl = !string.IsNullOrEmpty(feature.VideoUrl) ? NormalizeYouTubeUrl(feature.VideoUrl) : null;

    var imageUrl = string.IsNullOrEmpty(feature.ImageUrl) ? "/images/default.png" : feature.ImageUrl;
    var title = feature.Title ?? "";
    var mainTitle = feature.MainTitle ?? "";
    var description = feature.Description ?? "";
}

<section style="padding-top: 7rem; position: relative;">
    <div class="bg-holder"
         style="background-image:url('@imageUrl');
                background-size: cover;
                background-position: center;
                width: 100%;
                height: 100%;
                position: absolute;
                top: 0;
                left: 0;
                z-index: -1;">
    </div>

    <div class="container">
        <div class="row align-items-center text-white">
            <div class="col-md-7 col-lg-6 text-md-start text-center py-6">
                <h4 class="fw-bold text-danger mb-3">@title</h4>
                <h1 class="hero-title text-dark">@mainTitle</h1>
                <h3 class="mb-4 fw-medium text-dark">@Html.Raw(description)</h3>

                @if (!string.IsNullOrEmpty(videoUrl))
                {
                    <div class="text-center text-md-start">
                        <a href="#!" role="button" data-bs-toggle="modal" data-bs-target="#popupVideo">
                            <span class="btn btn-danger round-btn-lg rounded-circle me-3 danger-btn-shadow">
                                <img src="/public/assets/img/hero/play.svg" width="15" alt="play" />
                            </span>
                        </a>
                        <span class="fw-medium">@promoText</span>
                    </div>

                    <div class="modal fade" id="popupVideo" tabindex="-1" aria-labelledby="popupVideoLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered modal-lg">
                            <div class="modal-content">
                                <div class="ratio ratio-16x9">
                                    <iframe id="videoFrame"
                                            src="@videoUrl"
                                            title="YouTube video player" frameborder="0"
                                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                            allowfullscreen>
                                    </iframe>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</section>

<script>
    var videoModal = document.getElementById('popupVideo');
    var videoFrame = document.getElementById('videoFrame');

    if (videoModal && videoFrame) {
        videoModal.addEventListener('hidden.bs.modal', function () {
            videoFrame.src = videoFrame.src; // modal kapanınca videoyu durdur
        });
    }
</script>
